---
title: SQL Injection-Safe Queries
description: Build structurally safe database queries with cereal
author: zoobzio
published: 2025-12-30
updated: 2025-12-30
tags:
  - Cookbook
  - Database
  - Security
---

# SQL Injection-Safe Queries

Build queries that are structurally safe from SQL injection using sentinel and [cereal](https://github.com/zoobzio/cereal).

## The Security Model

Traditional query builders accept arbitrary strings:

```go
// Dangerous: field name comes from user input
db.Where(userInput + " = ?", value)  // SQL injection vector
```

Cereal eliminates this class of vulnerability. Your struct tags define the complete AST boundary:

```go
type User struct {
    ID    int64  `db:"id" constraints:"primarykey"`
    Email string `db:"email" constraints:"unique"`
    Name  string `db:"name"`
}
```

At initialization, sentinel extracts this metadata and cereal builds a validation schema. Every query is checked against it:

```go
users, _ := cereal.New[User](db, "users")

// Valid: "email" exists in schema
users.Select().Where(cereal.C("email", "=", "email"))

// Rejected: "emai" doesn't exist — caught immediately, not at runtime
users.Select().Where(cereal.C("emai", "=", "email"))  // Error: unknown field
```

User input can only provide *values*, never *structure*. The query shape is fixed by your type definition.

## How Sentinel Enables This

When you call `cereal.New[T]()`:

1. **Sentinel extracts metadata** — field names, types, and all tags
2. **Cereal builds a DBML schema** — defining valid tables, columns, constraints
3. **Queries validate against this schema** — invalid field names rejected immediately

```go
// Sentinel provides the source of truth
metadata := sentinel.Inspect[User]()

// metadata.Fields contains:
// - {Name: "ID", Type: "int64", Tags: {"db": "id", "constraints": "primarykey"}}
// - {Name: "Email", Type: "string", Tags: {"db": "email", "constraints": "unique"}}
// - {Name: "Name", Type: "string", Tags: {"db": "name"}}
```

This metadata becomes the allowlist. Anything not in your struct cannot appear in your query.

## Tag Conventions

Cereal interprets these tags to build the validation schema:

| Tag | Purpose | Example |
|-----|---------|---------|
| `db` | Column name | `db:"user_id"` |
| `type` | SQL type | `type:"bigserial"` |
| `constraints` | Column constraints | `constraints:"primarykey,not_null"` |
| `references` | Foreign key | `references:"users(id)"` |

## The Result

```go
// Define your model once
type Order struct {
    ID        int64   `db:"id" constraints:"primarykey"`
    UserID    int64   `db:"user_id" references:"users(id)"`
    Total     float64 `db:"total"`
    Status    string  `db:"status"`
}

// Initialize once — sentinel extraction happens here
orders, _ := cereal.New[Order](db, "orders")

// Build queries with confidence
orders.Select().
    Where(cereal.C("user_id", "=", "uid")).
    Where(cereal.C("status", "=", "status")).
    All(ctx, map[string]any{"uid": userId, "status": "pending"})
```

The struct is the contract. Sentinel extracts it. Cereal enforces it.

## See Also

- [cereal](https://github.com/zoobzio/cereal) — the query builder
- [dbml](https://github.com/zoobzio/dbml) — schema representation
- [Tags guide](../3.guides/2.tags.md) — custom tag registration
