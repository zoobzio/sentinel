# Testing with Sentinel

## Cache Behavior in Tests

Sentinel uses a global cache that persists across tests. This is usually fine because:

- Type metadata is deterministic
- Cache hits return identical data
- No side effects from cached metadata

## Isolated Test Instances

If you need cache isolation, clear the cache between tests:

```go
func TestSomething(t *testing.T) {
    // Tests run with whatever is cached
    metadata := sentinel.Inspect[MyType]()
    // ...
}
```

For integration tests that need clean state, the cache can be cleared via the test utilities in the `testing/integration` package.

## Testing Metadata Extraction

```go
func TestUserMetadata(t *testing.T) {
    metadata := sentinel.Inspect[User]()

    if metadata.TypeName != "User" {
        t.Errorf("expected User, got %s", metadata.TypeName)
    }

    if len(metadata.Fields) != 3 {
        t.Errorf("expected 3 fields, got %d", len(metadata.Fields))
    }
}
```

## Testing Relationships

```go
func TestUserRelationships(t *testing.T) {
    metadata := sentinel.Scan[User]()

    var hasProfile bool
    for _, rel := range metadata.Relationships {
        if rel.To == "Profile" && rel.Kind == "reference" {
            hasProfile = true
        }
    }

    if !hasProfile {
        t.Error("expected relationship to Profile")
    }
}
```

## Testing Tag Extraction

```go
func TestCustomTags(t *testing.T) {
    sentinel.Tag("custom")

    type Tagged struct {
        Field string `custom:"value"`
    }

    metadata := sentinel.Inspect[Tagged]()

    if metadata.Fields[0].Tags["custom"] != "value" {
        t.Error("custom tag not extracted")
    }
}
```

## Benchmarking

Run benchmarks to verify performance:

```bash
make bench
# or
go test -bench=. -benchmem ./testing/benchmarks/
```

Expected performance:
- Cache hit: ~80ns, 0 allocations
- Concurrent access: ~40ns per operation
